<!DOCTYPE html>
<html>
<head>
  <title>Карта Казани — Некомплект по лифтам (Яндекс)</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    html, body, #map {
      width: 100%; height: 100%; margin: 0; padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .sidebar {
      position: absolute; top: 10px; left: 10px;
      background: rgba(255, 255, 255, 0.95); padding: 15px;
      z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.2);
      border-radius: 12px; min-width: 260px; max-height: 90%; overflow-y: auto;
      border: 1px solid #ddd;
    }
    .sidebar h3 {
      margin-top: 0; font-size: 1.2em; border-bottom: 1px solid #ccc; padding-bottom: 5px;
    }
    .filter-controls {
      margin-bottom: 10px;
    }
    .filter-controls button {
      font-size: 14px; padding: 4px 8px; margin: 5px 5px 5px 0; cursor: pointer;
    }
    .filter-category {
      font-weight: bold; margin-top: 10px; cursor: pointer;
    }
    .filter-list {
      margin-left: 10px; display: none;
    }
    .summary {
      margin-top: 10px; font-size: 0.9em; color: #333;
    }
  </style>
  <script src="https://api-maps.yandex.ru/2.1/?apikey=a493d8d9-6875-4c13-91d6-08e7703b879f&lang=ru_RU" type="text/javascript"></script>
</head>
<body>
  <div class="sidebar">
    <h3>Фильтр по типу и наименованию</h3>
    <div class="filter-controls">
      <button onclick="toggleAllFilters(true)">Выбрать все</button>
      <button onclick="toggleAllFilters(false)">Убрать все</button>
    </div>
    <div id="filters"></div>
    <div id="summary" class="summary"></div>
  </div>
  <div id="map"></div>
  <script>
    const SHEET_ID = '1iMyG1z0ramdCKAX-5V-0CwWlZiFrqzwP4ujVSG8EN6k';
    const API_KEY = 'AIzaSyCAfEIQCxvq4vWZUfjKJ9ylQzGfg7Z0LAk';
    const RANGE = 'не комплект!A1:Z2000';

    let allData = [], map;
    const allPlacemarks = [];
    const filters = { type: new Set(), item: new Set() };
    const activeFilters = { type: new Set(), item: new Set() };

    function toggleAllFilters(state) {
      document.querySelectorAll('#filters input[type=checkbox]').forEach(cb => {
        cb.checked = state;
        const key = cb.dataset.key;
        const value = cb.value;
        if (state) activeFilters[key].add(value);
        else activeFilters[key].delete(value);
      });
      refreshMap();
    }

    function refreshMap() {
      map.geoObjects.removeAll();
      allPlacemarks.length = 0;

      const filteredGroups = {};
      const summary = {};
      allData.forEach(entry => {
        if (!activeFilters.type.has(entry.type) || !activeFilters.item.has(entry.item)) return;
        const coordKey = `${entry.lat},${entry.lng}`;
        if (!filteredGroups[coordKey]) filteredGroups[coordKey] = { coords: [parseFloat(entry.lat), parseFloat(entry.lng)], items: [] };
        filteredGroups[coordKey].items.push(entry);

        const summaryKey = `${entry.item}`;
        summary[summaryKey] = (summary[summaryKey] || 0) + parseInt(entry.qty || '0');
      });

      for (const key in filteredGroups) {
        const group = filteredGroups[key];
        const placemark = createPlacemark(group.coords, group.items, group.items[0].address);
        map.geoObjects.add(placemark);
        allPlacemarks.push({ placemark });
      }

      const summaryDiv = document.getElementById('summary');
      summaryDiv.innerHTML = '<b>Итоговое количество:</b><br>' + Object.entries(summary).map(([name, qty]) => `${name}: ${qty} шт.`).join('<br>');
    }

    function renderFilters() {
      const container = document.getElementById('filters');
      container.innerHTML = '';
      for (const key in filters) {
        const div = document.createElement('div');
        const title = document.createElement('div');
        title.className = 'filter-category';
        title.textContent = key === 'type' ? 'Тип детали' : 'Наименование';
        const list = document.createElement('div');
        list.className = 'filter-list';
        filters[key].forEach(val => {
          const label = document.createElement('label');
          const input = document.createElement('input');
          input.type = 'checkbox';
          input.checked = true;
          input.value = val;
          input.dataset.key = key;
          input.onchange = () => {
            if (input.checked) activeFilters[key].add(val);
            else activeFilters[key].delete(val);
            refreshMap();
          };
          label.appendChild(input);
          label.appendChild(document.createTextNode(' ' + val));
          list.appendChild(label);
          list.appendChild(document.createElement('br'));
        });
        title.onclick = () => list.style.display = list.style.display === 'block' ? 'none' : 'block';
        div.appendChild(title);
        div.appendChild(list);
        container.appendChild(div);
      }
    }

    async function fetchGoogleSheet(callback) {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
      const response = await fetch(url);
      const json = await response.json();
      const [headers, ...rows] = json.values;
      let lastAddress = '', lastOrder = '', lastContainer = '';
      const data = rows.map(row => {
        const obj = {};
        headers.forEach((header, i) => {
          obj[header.trim()] = row[i] ? row[i].trim() : "";
        });
        if (!obj["Адрес"]) obj["Адрес"] = lastAddress;
        if (!obj["№ заказа"]) obj["№ заказа"] = lastOrder;
        if (!obj["Тарное место"]) obj["Тарное место"] = lastContainer;
        lastAddress = obj["Адрес"];
        lastOrder = obj["№ заказа"];
        lastContainer = obj["Тарное место"];
        return {
          address: obj["Адрес"], order: obj["№ заказа"], container: obj["Тарное место"],
          type: obj["Тип детали"], item: obj["Наименование"], qty: obj["Кол-во"], delivered: obj["Дата досыла"],
          lat: obj["LAT"], lng: obj["LNG"]
        };
      });
      callback(data);
    }

    function createPlacemark(coords, group, address) {
      let content = `<b>${address}</b><br>`;
      const byOrder = {};
      group.forEach(entry => {
        if (!byOrder[entry.order]) byOrder[entry.order] = { details: [], delivered: entry.delivered };
        byOrder[entry.order].details.push(entry);
      });

      for (const order in byOrder) {
        const orderDetails = byOrder[order].details;
        const totalQty = orderDetails.reduce((sum, el) => sum + parseInt(el.qty || '0'), 0);
        content += `<hr><b>Лифт ${order}</b> — <i>${totalQty} шт</i>`;
        const delivered = byOrder[order].delivered;
        if (delivered) content += `<div><i>Досыл: ${delivered}</i></div>`;
        content += '<ul>';
        orderDetails.forEach(el => {
          content += `<li><b>${el.type}</b>: ${el.item} — ${el.qty} шт. (ТМ: ${el.container})</li>`;
        });
        content += '</ul>';
      }

      return new ymaps.Placemark(coords, {
        balloonContent: content
      }, {
        preset: 'islands#circleIcon', iconColor: 'red'
      });
    }

    ymaps.ready(() => {
      map = new ymaps.Map("map", {
        center: [55.7904, 49.1346], zoom: 12, controls: ['zoomControl']
      });

      fetchGoogleSheet(function(data) {
        allData = data;
        allData.forEach(row => {
          filters.type.add(row.type);
          filters.item.add(row.item);
          activeFilters.type.add(row.type);
          activeFilters.item.add(row.item);
        });
        renderFilters();
        refreshMap();
      });
    });
  </script>
</body>
</html>

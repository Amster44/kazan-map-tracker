<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Карта неконплекта</title>
  <script src="https://api-maps.yandex.ru/2.1/?lang=ru_RU" type="text/javascript"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }
    #map {
      width: 100%;
      height: 100%;
    }
    #sidebar {
      position: absolute;
      top: 0;
      left: 0;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px;
      overflow-y: auto;
      max-height: 100%;
      max-width: 300px;
      box-shadow: 2px 0 10px rgba(0,0,0,0.2);
    }
    .group {
      margin-bottom: 1em;
    }
    .group summary {
      font-weight: bold;
      cursor: pointer;
    }
    .checkbox-item {
      display: block;
      margin-left: 1em;
    }
    #toggle-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      z-index: 1000;
    }
  </style>
</head>
<body>
  <div id="sidebar"></div>
  <div id="toggle-panel">
    <button onclick="selectAll(true)">Выбрать всё</button>
    <button onclick="selectAll(false)">Убрать всё</button>
    <button onclick="location.reload()">Обновить карту</button>
  </div>
  <div id="map"></div>

  <script>
    const spreadsheetId = '1iMyG1z0ramdCKAX-5V-0CwWlZiFrqzwP4ujVSG8EN6k';
    const sheetName = 'не комплект';
    const apiKey = 'AIzaSyAdWV1lISfXjABrojS3JR_4wwh3m-hEhWM';
    const sheetUrl = `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/${sheetName}?key=${apiKey}`;

    let map;
    let markers = [];
    let filters = {};

    async function fetchSheet() {
      const res = await fetch(sheetUrl);
      const data = await res.json();
      return data.values;
    }

    function selectAll(state) {
      document.querySelectorAll('#sidebar input[type="checkbox"]').forEach(cb => {
        cb.checked = state;
      });
      renderMarkers();
    }

    function clearMarkers() {
      markers.forEach(m => map.geoObjects.remove(m));
      markers = [];
    }

    async function renderMarkers() {
      clearMarkers();
      const rows = await fetchSheet();
      const headers = rows[0];
      const data = rows.slice(1);

      const idx = {
        address: headers.indexOf('Адрес'),
        order: headers.indexOf('Номер заказа'),
        type: headers.indexOf('Тип детали'),
        name: headers.indexOf('Наименование'),
        qty: headers.indexOf('Количество'),
        lat: headers.indexOf('LAT'),
        lng: headers.indexOf('LNG'),
        delivered: headers.indexOf('Дата досыла')
      };

      const grouped = {};
      data.forEach(row => {
        const type = row[idx.type];
        const name = row[idx.name];
        if (!grouped[type]) grouped[type] = {};
        if (!grouped[type][name]) grouped[type][name] = 0;
        grouped[type][name] += +row[idx.qty] || 0;
      });

      createFilterUI(grouped);

      data.forEach(row => {
        const type = row[idx.type];
        const name = row[idx.name];
        const lat = parseFloat((row[idx.lat] || '').replace(',', '.'));
        const lng = parseFloat((row[idx.lng] || '').replace(',', '.'));
        const qty = row[idx.qty];
        const address = row[idx.address];
        const delivered = row[idx.delivered];

        if (!filters[type]?.[name]) return;
        if (!lat || !lng) return;

        const color = delivered ? 'green' : 'red';

        const placemark = new ymaps.Placemark([lat, lng], {
          balloonContent: `<b>${address}</b><br/>${type}: ${name}<br/>Кол-во: ${qty}<br/>${delivered ? '✅ Доставлено' : '⛔ Не доставлено'}`
        }, {
          preset: `islands#circleIcon`,
          iconColor: color
        });

        markers.push(placemark);
        map.geoObjects.add(placemark);
      });
    }

    function createFilterUI(grouped) {
      const sidebar = document.getElementById('sidebar');
      sidebar.innerHTML = '';
      filters = {};
      for (const [type, names] of Object.entries(grouped)) {
        const group = document.createElement('details');
        group.className = 'group';
        group.open = true;
        group.innerHTML = `<summary>${type}</summary>`;
        filters[type] = {};
        for (const [name, count] of Object.entries(names)) {
          filters[type][name] = true;
          const id = `cb-${type}-${name}`;
          const label = document.createElement('label');
          label.className = 'checkbox-item';
          label.innerHTML = `<input type="checkbox" id="${id}" checked> ${name} (${count})`;
          label.querySelector('input').addEventListener('change', () => {
            filters[type][name] = label.querySelector('input').checked;
            renderMarkers();
          });
          group.appendChild(label);
        }
        sidebar.appendChild(group);
      }
    }

    ymaps.ready(() => {
      map = new ymaps.Map("map", {
        center: [55.79, 49.12],
        zoom: 11
      });
      renderMarkers();
    });
  </script>
</body>
</html>
